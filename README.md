# make_defect.py Documentation

## Overview

This Python script is designed to parse a VASP `POSCAR` file, substitute one atom for another (or remove it entirely to create a vacancy), and write the resulting structure to a new `POSCAR` file. It supports **vacancy creation** and **element substitution**, while preserving the lattice and coordinate system.

By default, the script substitutes the atom closest to the **center of the unit cell** (`[0.5, 0.5, 0.5]`), but users can specify a **custom target position** for more precise defect placement.

---

## Functions

### `parse_poscar(file_path="POSCAR", verbose=False)`

Parses a VASP `POSCAR` file and extracts essential structural information.

#### Parameters:
- `file_path` (str): Path to the POSCAR file. Defaults to `"POSCAR"`.
- `verbose` (bool): Enables verbose terminal output.

#### Returns:
- `dict` with the following keys:
  - `lines`: Full original lines from the POSCAR file.
  - `atom_types`: List of element symbols.
  - `atom_counts`: List of atom counts per element.
  - `coord_type`: Coordinate type used (`Direct` or `Cartesian`).
  - `element_positions`: Dictionary mapping each element to its list of atomic positions.

---

### `substitute(parsed_data, substitution, site, target_position=None, verbose=False)`

Replaces an atom of type `site` (i.e., the atom to be removed) with the `substitution` atom (i.e., the atom to insert, or `'Va'` for vacancy).

#### Parameters:
- `parsed_data` (dict): Output from `parse_poscar()`.
- `substitution` (str): New atom type, or `'Va'` for vacancy.
- `site` (str): Atom type to be replaced.
- `target_position` (list of float or None): Optional fractional coordinate to find closest atom to. If `None`, defaults to `[0.5, 0.5, 0.5]`.
- `verbose` (bool): If `True`, prints detailed steps.

#### Behavior:
- Selects the atom of type `site` closest to the `target_position`.
- Removes that atom and optionally replaces it with the substitution atom.
- If the substitution is `'Va'`, no new atom is added.
- Atom counts and ordering are updated appropriately.

#### Returns:
- `new_lines` (list of str): Modified `POSCAR` content.
- `filename` (str): Suggested output filename (e.g., `"Va_Ga_POSCAR"`).

Printed output:
```
(Va → Ga, [0.125, 0.055555552, 0.166666672])
```

First line of output POSCAR:
```
Va_Ga defect 0.1250000000000000 0.0555555520000000 0.1666666720000000
```

---

### `write_poscar(new_lines, filename, verbose=False)`

Writes the modified structure to a new `POSCAR` file.

#### Parameters:
- `new_lines` (list): Lines generated by `substitute()`.
- `filename` (str): Output filename.
- `verbose` (bool): If `True`, full output to terminal.

---

## Example Usage

### Python Script (Direct Call)

```python
parsed_data = parse_poscar(verbose=True)  # verbose output
new_lines, filename = substitute(parsed_data, 'Va', 'Sb', target_position=[0.3, 0.5, 0.7], verbose=True)
write_poscar(new_lines, filename)  # writes new POSCAR: "Va_Sb_POSCAR"
```

### Command Line Interface

```bash
python make_defect.py Zn Ga                         # Zn → Ga substitution
python make_defect.py Va Ga                         # Ga vacancy
python make_defect.py Zn Ga --target 0.3 0.5 0.7    # replaces Zn nearest [0.3, 0.5, 0.7]
python make_defect.py Zn Ga -f GaN.POSCAR -o Zn_Ga_POSCAR -v  # custom input/output with verbose
```

---

### Verbose Output Example

```bash
python make_defect.py Va Ga --target 0.1 0.1 0.1 -v -o test_out
```

```
Reading POSCAR file from: POSCAR
Parsed atom types: ['Ga', 'N']
Parsed atom counts: [144, 144]
Total number of atoms: 288
Substituting Ga with Va
Selected atom at: [0.125, 0.055555552, 0.166666672] (closest to [0.1, 0.1, 0.1])
(Va → Ga, [0.125, 0.055555552, 0.166666672])
Written updated POSCAR to 'test_out'
```

---

## Command Line Arguments

| Argument          | Type              | Required | Description                                                       |
|-------------------|-------------------|----------|-------------------------------------------------------------------|
| `substitution`    | `str`             | Yes      | Atom to insert (or `'Va'` for vacancy)                            |
| `site`            | `str`             | Yes      | Atom type to be replaced                                          |
| `-f`, `--file`    | `str`             | No       | Input `POSCAR` file (default: `"POSCAR"`)                         |
| `-o`, `--output`  | `str`             | No       | Output filename (default: auto-generated, e.g., `Va_Sb_POSCAR`)   |
| `--target`        | `3 floats`        | No       | Fractional coordinates (`x y z`) to locate the closest atom       |
| `-v`, `--verbose` | Flag              | No       | Enable detailed output messages                                   |

---

## Notes

- Vacancy creation is supported by passing `'Va'` as the substitution symbol.
- By default, the atom closest to the center of the unit cell `[0.5, 0.5, 0.5]` is selected for substitution.
- Output filenames are auto-generated based on the substitution and site (e.g., `Zn_Ga_POSCAR`), unless specified via `-o`.

---
